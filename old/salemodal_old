<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Добавить продажу</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;font-size:16px;padding:16px;color:#111;}
  h3{font-size:20px;margin:0 0 12px 0;}
  .row{display:flex;gap:12px;margin-bottom:10px;}
  .col{flex:1;min-width:160px;position:relative;}
  label{display:block;font-size:15px;margin-bottom:6px;}
  input[type=text], input[type=number], select { width:100%; padding:9px; box-sizing:border-box; font-size:16px; }
  .note{font-size:13px;color:#666;margin-top:6px;}
  .error{color:#c00;font-size:13px;margin-top:6px;}
  .typeahead-list{position:absolute;background:#fff;border:1px solid #ccc;max-height:220px;overflow:auto;z-index:100;width:100%;}
  .typeahead-item{padding:8px;cursor:pointer;}
  .typeahead-item:hover{background:#f0f0f0;}
  .radios{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
  .actions{text-align:right;margin-top:14px;}
  button{padding:8px 14px;font-size:15px;}
</style>
</head>
<body>
  <h3>Добавить продажу</h3>

  <div id="headerError" class="error" style="display:none;"></div>

  <form id="form" onsubmit="onSubmit(event)">
    <div class="row">
      <div class="col">
        <label>Дата (dd.MM.yyyy)</label>
        <input id="date" type="text" />
        <div id="dateError" class="error"></div>
        <div id="dateNote" class="note"></div>
      </div>

      <div class="col">
        <label>Клиент (обязательно, из Справочника)</label>
        <input id="client" type="text" autocomplete="off" placeholder="Поиск по имени или номеру" />
        <div id="clientList" class="typeahead-list" style="display:none"></div>
        <div id="clientError" class="error"></div>
        <div id="clientNote" class="note"></div>
      </div>

      <div class="col">
        <label>Продукт</label>
        <input id="product" type="text" autocomplete="off" placeholder="Выберите продукт" />
        <div id="productList" class="typeahead-list" style="display:none"></div>
        <div id="productError" class="error"></div>
        <div id="productNote" class="note"></div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Скидка (%)</label>
        <input id="discount" type="number" min="0" max="100" step="0.01" value="0" />
        <div id="discountError" class="error"></div>
      </div>

      <div class="col">
        <label>Итоговая стоимость (авто)</label>
        <input id="finalPrice" type="number" readonly />
        <div id="finalNote" class="note"></div>
      </div>

      <div class="col">
        <label>Оплата (выберите один)</label>
        <div class="radios" id="paymentRadios">
          <label><input type="radio" name="payment" value="Наличные"> Наличные</label>
          <label><input type="radio" name="payment" value="Перевод"> Перевод</label>
          <label><input type="radio" name="payment" value="Терминал"> Терминал</label>
          <label><input type="radio" name="payment" value="Вдолг"> Вдолг</label>
        </div>
        <div id="paymentError" class="error"></div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Комментарий (обязательно если скидка выше стандартной)</label>
        <input id="comment" type="text" />
        <div id="commentError" class="error"></div>
      </div>

      <div class="col">
        <label>Тренер (опционально — показываются только тренеры по типу продукта)</label>
        <input id="trainer" type="text" autocomplete="off" placeholder="Выберите тренера" />
        <div id="trainerList" class="typeahead-list" style="display:none"></div>
        <div id="trainerNote" class="note"></div>
      </div>

      <div class="col">
        <label>Админ (авто)</label>
        <input id="admin" type="text" readonly />
        <div class="note">Определяется по вашему Google account (если есть в справочнике)</div>
      </div>
    </div>

    <div class="actions">
      <button type="button" onclick="google.script.host.close()">Отмена</button>
      <button id="ok" type="submit">Добавить</button>
    </div>
  </form>

<script>
  var products = [], clients = [], staff = [];
  var selectedProduct = null;
  var defaultDiscount = 0;
  var matchedClient = null;

  function init(){
    google.script.run.withSuccessHandler(function(res){
      if (!res.ok) {
        document.getElementById('headerError').style.display = 'block';
        document.getElementById('headerError').textContent = res.msg + (res.diffs ? (' — проверьте колонки: ' + JSON.stringify(res.diffs)) : '');
        document.getElementById('ok').disabled = true;
      } else {
        document.getElementById('headerError').style.display = 'none';
        document.getElementById('ok').disabled = false;
      }
    }).verifySalesHeaders();

    google.script.run.withSuccessHandler(function(p){ products = p || []; initProductTA(); }).getProducts();
    google.script.run.withSuccessHandler(function(c){ clients = c || []; initClientTA(); }).getClients();
    google.script.run.withSuccessHandler(function(s){ staff = s || []; initTrainerTA(); }).getStaff();
    google.script.run.withSuccessHandler(function(res){ if (res && res.adminName) document.getElementById('admin').value = res.adminName; }).getAdminForCurrentUser();

    var dt = new Date();
    document.getElementById('date').value = String(dt.getDate()).padStart(2,'0') + '.' + String(dt.getMonth()+1).padStart(2,'0') + '.' + dt.getFullYear();

    document.getElementById('discount').addEventListener('input', onDiscountChange);
    document.getElementById('product').addEventListener('blur', onProductBlur);
    document.getElementById('date').addEventListener('blur', function(){
      google.script.run.withSuccessHandler(showDateValidation).validateDateServer(document.getElementById('date').value);
    });
  }

  function showDateValidation(res){
    document.getElementById('dateError').textContent = res.ok ? '' : res.msg;
  }

  function computeDefaultDiscount(product) {
    if (!product) return 0;
    var type = product.type || '';
    var nameLc = (product.name || '').toString().toLowerCase();
    if ((type === 'Бассейн' || type === 'Ванны') && nameLc.indexOf('пробное') !== -1) return 50;
    if (type === 'Бассейн' || type === 'Ванны') return 15;
    return 0;
  }

  function initProductTA(){
    attachTypeaheadObjects('product','productList', products, function(item){
      selectedProduct = item;
      document.getElementById('product').value = item.name || '';
      defaultDiscount = computeDefaultDiscount(item);
      document.getElementById('discount').value = defaultDiscount;
      document.getElementById('productNote').textContent = (item.type?item.type+' / ':'') + (item.category||'') + (typeof item.fullPrice !== 'undefined' ? ' • price: ' + item.fullPrice : '');
      if (['сгорел','возврат абонемента','перерасчёт'].indexOf((item.name||'').toString().toLowerCase()) !== -1) {
        document.getElementById('productError').textContent = 'Запрещённый продукт';
        selectedProduct = null;
      } else {
        document.getElementById('productError').textContent = '';
      }
      recalcFinal();
      document.getElementById('trainerNote').textContent = item.type ? 'Показываются тренеры: ' + item.type : '';
    });
  }

  function onProductBlur(){
    var val = document.getElementById('product').value.trim().toLowerCase();
    if (!val) return;
    var found = products.find(function(p){ return (p.name||'').toString().toLowerCase() === val; });
    if (found) {
      selectedProduct = found;
      defaultDiscount = computeDefaultDiscount(found);
      document.getElementById('discount').value = defaultDiscount;
      document.getElementById('productNote').textContent = (found.type?found.type+' / ':'') + (found.category||'') + (typeof found.fullPrice !== 'undefined' ? ' • price: ' + found.fullPrice : '');
      document.getElementById('productError').textContent = '';
      recalcFinal();
      document.getElementById('trainerNote').textContent = found.type ? 'Показываются тренеры: ' + found.type : '';
    }
  }

  function initClientTA(){
    attachTypeaheadObjects('client','clientList', clients, function(item){
      document.getElementById('client').value = item.name || item.mobile || '';
      document.getElementById('clientNote').textContent = 'Выбран: ' + (item.name||'') + (item.mobile?(' — '+item.mobile):'');
      document.getElementById('clientError').textContent = '';
      matchedClient = item;
    });
  }

  function initTrainerTA(){
    attachTypeaheadFiltered('trainer','trainerList', staff, function(item){
      document.getElementById('trainer').value = item.name || '';
      document.getElementById('trainerNote').textContent = 'Тренер: ' + (item.name||'') + (item.type?(' ('+item.type+')'):'');
    });
  }

  function attachTypeaheadObjects(inpId, listId, srcArray, onSelect){
    var inp = document.getElementById(inpId), list = document.getElementById(listId);
    inp.addEventListener('input', function(){
      var q = inp.value.trim().toLowerCase();
      if (!q){ list.style.display='none'; return; }
      var matches = [];
      for (var i=0;i<srcArray.length;i++){
        var item = srcArray[i];
        var hay = ((item.name||'') + ' ' + (item.mobile||'') + ' ' + (item.email||'') + ' ' + (item.type||'')).toLowerCase();
        if (hay.indexOf(q) !== -1) matches.push(item);
        if (matches.length >= 12) break;
      }
      if (!matches.length){ list.style.display='none'; return; }
      list.innerHTML = '';
      matches.forEach(function(m){
        var div = document.createElement('div');
        div.className = 'typeahead-item';
        var text = (m.name||'') + (m.mobile?(' — ' + m.mobile):'') + (m.email?(' — ' + m.email):'') + (m.type?(' ('+m.type+')'):'');
        div.textContent = text;
        div.addEventListener('click', function(){ list.style.display='none'; onSelect(m); });
        list.appendChild(div);
      });
      list.style.display='block';
    });
    document.addEventListener('click', function(e){ if (!list.contains(e.target) && e.target !== inp) list.style.display='none'; });
  }

  function attachTypeaheadFiltered(inpId, listId, srcArray, onSelect){
    var inp = document.getElementById(inpId), list = document.getElementById(listId);
    inp.addEventListener('input', function(){
      var q = inp.value.trim().toLowerCase();
      var needType = selectedProduct ? selectedProduct.type : null;
      if (!q && !needType){ list.style.display='none'; return; }
      var matches = [];
      for (var i=0;i<srcArray.length;i++){
        var item = srcArray[i];
        if (!item.name) continue;
        if (item.type === 'Администратор') continue;
        if (needType && item.type !== needType) continue;
        var hay = (item.name + ' ' + (item.email||'') + ' ' + (item.type||'')).toLowerCase();
        if (hay.indexOf(q) !== -1) matches.push(item);
        if (matches.length >= 12) break;
      }
      if (!matches.length){ list.style.display='none'; return; }
      list.innerHTML = '';
      matches.forEach(function(m){
        var div = document.createElement('div');
        div.className = 'typeahead-item';
        div.textContent = (m.name || '') + (m.email ? (' — ' + m.email) : '') + (m.type ? (' ('+m.type+')') : '');
        div.addEventListener('click', function(){ list.style.display='none'; onSelect(m); });
        list.appendChild(div);
      });
      list.style.display='block';
    });
    document.addEventListener('click', function(e){ if (!list.contains(e.target) && e.target !== inp) list.style.display='none'; });
  }

  function recalcFinal(){
    var base = 0;
    if (selectedProduct && typeof selectedProduct.fullPrice !== 'undefined' && selectedProduct.fullPrice !== null) {
      base = Number(selectedProduct.fullPrice) || 0;
    }
    var discountPercent = Number(document.getElementById('discount').value || 0);
    if (isNaN(discountPercent)) discountPercent = 0;
    if (discountPercent < 0) discountPercent = 0;
    if (discountPercent > 100) discountPercent = 100;
    var final = Math.round((base * (1 - discountPercent / 100)) * 100) / 100;
    document.getElementById('finalPrice').value = final;
    document.getElementById('finalNote').textContent = 'Базовая цена: ' + base;
    if (discountPercent > defaultDiscount && defaultDiscount > 0) document.getElementById('commentError').textContent = 'Скидка выше стандартной (' + defaultDiscount + '%) — добавьте комментарий.';
    else document.getElementById('commentError').textContent = '';
  }

  function onDiscountChange(){ recalcFinal(); }

  function clearErrors(){ ['dateError','clientError','productError','discountError','paymentError','commentError','headerError'].forEach(function(id){ var el=document.getElementById(id); if(el) el.textContent=''; }); }

  function onSubmit(e){
    e.preventDefault();
    clearErrors();
    var ok = true;
    var date = document.getElementById('date').value.trim();
    if (!date){ document.getElementById('dateError').textContent='Укажите дату'; ok=false; }

    var clientVal = document.getElementById('client').value.trim();
    if (!clientVal){ document.getElementById('clientError').textContent='Клиент обязателен (Справочник)'; ok=false; }
    else {
      matchedClient = clients.find(function(c){ return (c.name && c.name.toLowerCase() === clientVal.toLowerCase()) || (c.mobile && c.mobile.replace(/\D/g,'') === clientVal.replace(/\D/g,'')); });
      if (!matchedClient){ document.getElementById('clientError').textContent='Клиент не найден в Справочнике'; ok=false; }
    }

    var prodVal = document.getElementById('product').value.trim();
    if (!prodVal){ document.getElementById('productError').textContent='Выберите продукт'; ok=false; }
    if (!selectedProduct || selectedProduct.name.toLowerCase() !== prodVal.toLowerCase()){
      var found = products.find(function(p){ return p.name && p.name.toLowerCase() === prodVal.toLowerCase(); });
      if (!found){ document.getElementById('productError').textContent='Продукт не найден'; ok=false; }
      else {
        selectedProduct = found;
        defaultDiscount = computeDefaultDiscount(found);
        document.getElementById('discount').value = defaultDiscount;
        recalcFinal();
      }
    }
    if (selectedProduct && ['сгорел','возврат абонемента','перерасчёт'].indexOf(selectedProduct.name.toLowerCase()) !== -1){
      document.getElementById('productError').textContent='Запрещённый продукт'; ok=false;
    }

    var discount = Number(document.getElementById('discount').value || 0);
    if (isNaN(discount) || discount < 0 || discount > 100){ document.getElementById('discountError').textContent='Неверная скидка'; ok=false; }

    var paymentRadios = document.getElementsByName('payment');
    var payment = '';
    for (var r=0;r<paymentRadios.length;r++) if (paymentRadios[r].checked) payment = paymentRadios[r].value;
    if (!payment){ document.getElementById('paymentError').textContent='Выберите оплату'; ok=false; }

    var comment = document.getElementById('comment').value || '';
    if (discount > defaultDiscount && defaultDiscount > 0 && comment.trim() === '') { document.getElementById('commentError').textContent = 'Комментарий обязателен при повышенной скидке'; ok = false; }

    if (!ok) return;

    var payload = {
      date: date,
      client: { displayName: matchedClient.name, mobile: matchedClient.mobile },
      product: { name: selectedProduct.name, type: selectedProduct.type, category: selectedProduct.category, fullPrice: selectedProduct.fullPrice, quantity: selectedProduct.quantity },
      qty: selectedProduct.quantity || 1,
      discount: discount,
      paymentMethod: payment,
      comment: comment,
      trainer: { name: document.getElementById('trainer').value || '' }
    };

    document.getElementById('ok').disabled = true;
    google.script.run.withSuccessHandler(function(res){
      try { google.script.host.close(); } catch(e){}
    }).withFailureHandler(function(err){
      var msg = (err && err.message) ? err.message : String(err);
      document.getElementById('headerError').style.display='block';
      document.getElementById('headerError').textContent = msg;
      document.getElementById('ok').disabled = false;
    }).createSale(payload);
  }

  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
