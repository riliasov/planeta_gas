<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 13px;
            color: #333;
            margin: 0;
            background-color: #fff;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        /* Consistent fonts for inputs */
        input,
        select,
        button {
            font-family: inherit;
        }

        /* Tabs Header - Sticky */
        .tabs-header {
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            background: #fff;
            padding: 2px;
            margin-bottom: 6px;
            gap: 2px;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6px 2px;
            border: none;
            background: none;
            cursor: pointer;
            color: #757575;
            transition: all 0.2s;
            border-radius: 8px;
        }

        .tab-btn:hover {
            background: #f0f0f0;
            color: #1976d2;
        }

        .tab-btn.active {
            color: #1976d2;
            background: #e3f2fd;
        }

        .tab-btn i {
            font-size: 20px;
            margin-bottom: 2px;
        }

        .tab-btn span {
            font-size: 10px;
            font-weight: 500;
        }

        /* Section Container */
        .tab-content {
            display: none;
            padding: 0 6px 6px 6px;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: #fff;
            margin-bottom: 4px;
        }

        .section-header {
            display: flex;
            align-items: center;
            padding: 2px 4px;
            border-bottom: 1px solid #f1f1f1;
            margin-bottom: 4px;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            font-size: 13px;
            color: #444;
        }

        .section-content {
            padding: 0 4px;
        }

        label {
            display: block;
            margin-bottom: 2px;
            font-weight: 600;
            font-size: 11px;
            color: #555;
            line-height: 1.2;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="number"],
        select {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 13px;
            transition: border-color 0.2s;
        }

        input:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
        }

        .row {
            display: flex;
            gap: 12px;
        }

        .col {
            flex: 1;
        }

        .btn {
            width: 100%;
            padding: 10px;
            background-color: #1976d2;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: background 0.2s;
        }

        .btn:hover {
            background-color: #1565c0;
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .link-btn {
            background: none;
            border: none;
            color: #1976d2;
            padding: 2px 4px;
            cursor: pointer;
            font-size: 11px;
            text-decoration: underline;
        }

        .error {
            color: #d32f2f;
            font-size: 10px;
            margin-top: 4px;
            min-height: 14px;
        }

        .note {
            font-size: 10px;
            color: #1976d2;
            margin-top: 2px;
        }

        /* Typeahead Container */
        .typeahead-list {
            position: absolute;
            z-index: 1000;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .typeahead-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .typeahead-item:hover {
            background-color: #f5f5f5;
        }

        /* Swiper Switch Styles */
        .switch-container {
            display: flex;
            background: #f1f3f4;
            border-radius: 8px;
            padding: 3px;
            position: relative;
            cursor: pointer;
            user-select: none;
        }

        .switch-option {
            flex: 1;
            text-align: center;
            padding: 6px 0;
            font-size: 11px;
            font-weight: 600;
            z-index: 2;
            color: #5f6368;
            transition: color 0.3s;
        }

        .switch-option.active {
            color: #1976d2;
        }

        .switch-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: calc(50% - 3px);
            height: calc(100% - 6px);
            background: #fff;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
        }

        .switch-container.right .switch-slider {
            transform: translateX(100%);
        }

        .switch-container.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .radios {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 4px 0;
        }

        .radios label {
            display: flex;
            align-items: center;
            font-weight: normal;
            cursor: pointer;
        }

        .radios input {
            margin-right: 5px;
        }

        .price-summary {
            background: transparent;
            border: none;
            padding: 4px 0;
            margin-top: 4px;
            display: none;
        }

        .status {
            font-size: 10px;
            color: #666;
            text-align: center;
            margin-top: 8px;
            min-height: 16px;
        }

        .task {
            font-size: 11px;
            padding: 6px 8px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: #333;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            margin-top: 8px;
        }

        .history-table th {
            text-align: left;
            color: #777;
            border-bottom: 1px solid #eee;
            padding: 4px;
        }

        .history-table td {
            padding: 4px;
            border-bottom: 1px dotted #fafafa;
        }

        /* Toast Styling */
        #toast {
            visibility: hidden;
            min-width: 200px;
            background-color: rgba(33, 33, 33, 0.85);
            color: #fff;
            text-align: center;
            border-radius: 20px;
            padding: 10px 20px;
            position: fixed;
            z-index: 2000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 13px;
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <!-- Nav Tabs Header -->
    <div class="tabs-header">
        <button class="tab-btn active" data-tab="tasks">
            <i class="material-icons">assignment</i>
            <span>–ó–∞–¥–∞—á–∏</span>
        </button>
        <button class="tab-btn" data-tab="sale">
            <i class="material-icons">shopping_cart</i>
            <span>–ü—Ä–æ–¥–∞–∂–∏</span>
        </button>
        <button class="tab-btn" data-tab="schedule">
            <i class="material-icons">event</i>
            <span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span>
        </button>
        <button class="tab-btn" data-tab="clients">
            <i class="material-icons">people</i>
            <span>–ö–ª–∏–µ–Ω—Ç—ã</span>
        </button>
    </div>

    <!-- ===== –†–ê–ó–î–ï–õ: –ó–ê–î–ê–ß–ò ===== -->
    <div id="tab_tasks" class="tab-content active">
        <div class="section">
            <div class="section-header" style="padding: 8px 12px;">
                <div class="section-title">–ó–∞–¥–∞—á–∏</div>
                <button id="tasks_refresh" class="link-btn" title="–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫"
                    style="margin-left:auto; font-size: 16px; padding: 4px 8px;">‚Üª</button>
            </div>
            <div class="section-content">
                <div id="tasks_list"></div>
                <div id="tasks_empty" class="note" style="display:none; text-align:center;">–í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!</div>
            </div>
        </div>
    </div>

    <!-- ===== –†–ê–ó–î–ï–õ: –ü–†–û–î–ê–ñ–ê ===== -->
    <div id="tab_sale" class="tab-content">
        <div class="section">
            <div class="section-content">
                <div style="margin-top:0;">
                    <label>–î–∞—Ç–∞</label>
                    <input id="sb_date" type="text" placeholder="–î–î.–ú–ú.–ì–ì–ì–ì">
                    <div id="sb_date_err" class="error"></div>
                </div>

                <div style="margin-top:4px; position:relative;">
                    <label>–ö–ª–∏–µ–Ω—Ç</label>
                    <input id="sb_client" type="text" autocomplete="off" placeholder="–ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞">
                    <div id="sb_client_list" class="typeahead-list" style="display:none;"></div>
                    <div id="sb_client_info" class="note" style="display:none; margin-top:2px;"></div>
                    <div id="sb_client_err" class="error"></div>
                </div>

                <div style="margin-top:4px; position:relative;">
                    <label>–ü—Ä–æ–¥—É–∫—Ç</label>
                    <input id="sb_product" type="text" autocomplete="off" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ">
                    <div id="sb_product_list" class="typeahead-list" style="display:none;"></div>
                    <div id="sb_product_err" class="error"></div>
                </div>


                <div class="row" style="margin-top:4px;">
                    <div class="col">
                        <label>–°–∫–∏–¥–∫–∞ (%)</label>
                        <input id="sb_discount" type="text" inputmode="decimal" placeholder="0" value="0">
                        <div id="sb_discount_err" class="error"></div>
                    </div>
                </div>
                <div id="price_summary_block" class="price-summary"></div>

                <div style="margin-top:4px;">
                    <label>–û–ø–ª–∞—Ç–∞</label>
                    <div class="radios" id="sb_payment_radios">
                        <label><input type="radio" name="sb_payment" value="–ù–∞–ª–∏—á–Ω—ã–µ"> –ù–∞–ª–∏—á–Ω—ã–µ</label>
                        <label><input type="radio" name="sb_payment" value="–ü–µ—Ä–µ–≤–æ–¥"> –ü–µ—Ä–µ–≤–æ–¥</label>
                        <label><input type="radio" name="sb_payment" value="–¢–µ—Ä–º–∏–Ω–∞–ª"> –¢–µ—Ä–º–∏–Ω–∞–ª</label>
                        <label><input type="radio" name="sb_payment" value="–í–¥–æ–ª–≥"> –í–¥–æ–ª–≥</label>
                    </div>
                    <div id="sb_payment_err" class="error"></div>
                </div>

                <div style="margin-top:4px;">
                    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <input id="sb_comment" type="text" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">
                    <div id="sb_comment_err" class="error"></div>
                </div>

                <div style="margin-top:4px; position:relative;">
                    <label>–¢—Ä–µ–Ω–µ—Ä</label>
                    <input id="sb_trainer" type="text" autocomplete="off"
                        placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∏–º—è (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                    <div id="sb_trainer_list" class="typeahead-list" style="display:none;"></div>
                    <div id="sb_trainer_note" class="note"></div>
                </div>

                <div style="margin-top:8px;">
                    <button id="sb_add" class="btn">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É</button>
                    <div id="sb_status" class="status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== –†–ê–ó–î–ï–õ: –†–ê–°–ü–ò–°–ê–ù–ò–ï ===== -->
    <div id="tab_schedule" class="tab-content">
        <div class="section">
            <div class="section-content">
                <div style="margin-top:6px;">
                    <label>–î–∞—Ç–∞ –∑–∞–Ω—è—Ç–∏—è</label>
                    <input id="sch_date" type="date">
                    <div id="sch_date_err" class="error"></div>
                </div>

                <div style="margin-top:12px;">
                    <label>–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</label>
                    <input id="sch_time" type="time" step="600">
                    <div id="sch_time_err" class="error"></div>
                    <div id="sch_time_note" class="note" style="color:#d32f2f; display:none;"></div>
                </div>

                <div class="row" style="margin-top:12px;">
                    <div class="col">
                        <label>–¢–∏–ø –∑–∞–Ω—è—Ç–∏—è</label>
                        <div class="switch-container" id="sw_type_container">
                            <div class="switch-slider"></div>
                            <div class="switch-option active" data-val="–ë–∞—Å—Å–µ–π–Ω" id="sw_type_pool">–ë–∞—Å—Å–µ–π–Ω
                            </div>
                            <div class="switch-option" data-val="–í–∞–Ω–Ω—ã" id="sw_type_bath">–í–∞–Ω–Ω—ã</div>
                        </div>
                    </div>
                    <div class="col">
                        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <div class="switch-container" id="sw_cat_container">
                            <div class="switch-slider"></div>
                            <div class="switch-option active" data-val="–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π" id="sw_cat_ind">–ò–Ω–¥.
                            </div>
                            <div class="switch-option" data-val="–ì—Ä—É–ø–ø–æ–≤–æ–π" id="sw_cat_grp">–ì—Ä—É–ø–ø.</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top:8px; position:relative;">
                    <label>–ö–ª–∏–µ–Ω—Ç</label>
                    <input id="sch_client" type="text" autocomplete="off" placeholder="–ò–º—è –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω">
                    <div id="sch_client_list" class="typeahead-list" style="display:none;"></div>
                    <div id="sch_client_info" class="note" style="display:none; margin-top:4px;"></div>
                    <div id="sch_client_err" class="error"></div>
                </div>

                <div style="margin-top:8px; position:relative;">
                    <label style="display:flex; justify-content:space-between;">
                        <span>–¢—Ä–µ–Ω–µ—Ä</span>
                        <span id="sch_trainer_note" style="font-weight:normal; color:#1976d2;"></span>
                    </label>
                    <input id="sch_trainer" type="text" autocomplete="off" placeholder="–ü–æ–∏—Å–∫ —Ç—Ä–µ–Ω–µ—Ä–∞">
                    <div id="sch_trainer_list" class="typeahead-list" style="display:none;"></div>
                    <div id="sch_trainer_err" class="error"></div>
                    <div id="sch_trainer_conflict" class="error" style="display:none; color:#f00; font-weight:600;">
                    </div>
                </div>

                <div style="margin-top:8px;">
                    <button id="sch_add" class="btn">–ó–∞–ø–∏—Å–∞—Ç—å</button>
                    <div id="sch_status" class="status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== –†–ê–ó–î–ï–õ: –ö–õ–ò–ï–ù–¢–´ ===== -->
    <div id="tab_clients" class="tab-content">
        <div class="section">
            <div class="section-content">
                <div style="position:relative;">
                    <input id="cl_search" type="text"
                        placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –§–ò–û –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ –∏–º—è —Ä–µ–±–µ–Ω–∫–∞" autocomplete="off">
                    <div id="cl_search_list" class="typeahead-list" style="display:none;"></div>
                </div>
                <div id="cl_client_card"
                    style="display:none; margin-top:12px; padding:10px; background:#f8fbff; border:1px solid #c2e0ff; border-radius:10px;">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px 12px;">
                        <div>
                            <label style="margin-bottom:0;">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                            <div id="cl_card_phone" style="font-size:12px;">-</div>
                        </div>
                        <div>
                            <label style="margin-bottom:0;">–ë–∞–ª–∞–Ω—Å</label>
                            <div id="cl_card_balance" style="font-size:12px; font-weight:700; color:#2e7d32;"></div>
                        </div>
                        <div>
                            <label style="margin-bottom:0;">–°–ø–∏—Å–∞–Ω–æ</label>
                            <div id="cl_card_spent" style="font-size:12px; color:#555;">-</div>
                        </div>
                        <div>
                            <label style="margin-bottom:0;">–î–æ–ª–≥</label>
                            <div id="cl_card_debt" style="font-size:12px; color:#d32f2f;">-</div>
                        </div>
                        <div>
                            <label style="margin-bottom:0;">–†–µ–±–µ–Ω–æ–∫</label>
                            <div id="cl_card_child" style="font-size:12px;">-</div>
                        </div>
                        <div>
                            <label style="margin-bottom:0;">–î–† –†–µ–±–µ–Ω–∫–∞</label>
                            <div id="cl_card_dr" style="font-size:12px;">-</div>
                        </div>
                        <div>
                            <label style="margin-bottom:0;">–í–æ–∑—Ä–∞—Å—Ç</label>
                            <div id="cl_card_age" style="font-size:12px;">-</div>
                        </div>
                        <div>
                            <label style="margin-bottom:0;">–°—Ç–∞—Ç—É—Å</label>
                            <div id="cl_card_status" style="font-weight:600; font-size:11px; color:#1976d2;"></div>
                        </div>
                    </div>
                    <div id="cl_history" style="margin-top:8px; border-top:1px solid #eee; padding-top:4px;">
                        <div style="font-weight:600; margin-bottom:4px; font-size:10px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏</div>
                        <div id="cl_sales_list"></div>
                        <div style="font-weight:600; margin-top:12px; margin-bottom:4px; font-size:10px;">–ó–∞–ø–∏—Å–∏
                            (–ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –∏ –ø—Ä–æ—à–µ–¥—à–∏–µ)</div>
                        <div id="cl_training_list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast UI -->
    <div id="toast"></div>

    <script>
        // ===== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =====
        var products = [], clients = [], staff = [];
        var sb_selectedProduct = null, sb_defaultDiscount = 0, sb_matchedClient = null;
        var sch_matchedClient = null, sch_selectedTrainer = null;
        var sch_roomType = "–ë–∞—Å—Å–µ–π–Ω", sch_category = "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π";

        // ===== –£–¢–ò–õ–ò–¢–´ =====

        /**
         * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª (—É–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–±–µ–ª—ã, –∑–∞–º–µ–Ω—è–µ—Ç –∑–∞–ø—è—Ç—ã–µ)
         */
        function formatNum(val) {
            if (val === null || val === undefined || val === '') return '0';
            var n = parseFloat(val.toString().replace(/\s/g, '').replace(',', '.'));
            if (isNaN(n)) return val;
            return n.toString();
        }

        /**
         * –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç—ã (–î–î.–ú–ú.–ì–ì–ì–ì)
         */
        function validateDate(dateStr) {
            var parts = dateStr.split('.');
            if (parts.length !== 3) return false;
            var d = parseInt(parts[0]), m = parseInt(parts[1]), y = parseInt(parts[2]);
            if (d < 1 || d > 31 || m < 1 || m > 12 || y < 2000) return false;
            return true;
        }

        /**
         * DOM —Ö—ç–ª–ø–µ—Ä—ã
         */
        function el(tag, props) {
            var e = document.createElement(tag);
            if (props) Object.keys(props).forEach(function (k) {
                if (k === 'text') e.textContent = props[k];
                else if (k === 'className') e.className = props[k];
                else e.setAttribute(k, props[k]);
            });
            return e;
        }

        function setText(id, txt) {
            var el = document.getElementById(id);
            if (el) el.textContent = txt || (txt === 0 ? '0' : '-');
        }

        function setHtml(id, html) {
            var el = document.getElementById(id);
            if (el) el.innerHTML = html || '';
        }

        /**
         * Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
         */
        function showToast(msg, isError) {
            var x = document.getElementById("toast");
            x.textContent = msg;
            x.style.backgroundColor = isError ? "rgba(211, 47, 47, 0.9)" : "rgba(33, 33, 33, 0.85)";
            x.className = "show";
            setTimeout(function () { x.className = x.className.replace("show", ""); }, 3000);
        }

        /**
         * –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —Ç–∞–±–∞–º–∏
         */
        function openClient(name) {
            if (!name) return;
            var item = clients.find(function (c) { return c.name === name; });
            if (!item) return;

            var tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(function (b) { b.classList.remove('active'); });
            var clientBtn = Array.from(tabBtns).find(function (b) { return b.getAttribute('data-tab') === 'clients'; });
            if (clientBtn) clientBtn.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(function (c) { c.classList.remove('active'); });
            document.getElementById('tab_clients').classList.add('active');

            document.getElementById('cl_search').value = item.name;
            updateClientCard('cl', item);
        }

        // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
        function initSidebar() {
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–∞–±–æ–≤
            var tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(function (btn) {
                btn.addEventListener('click', function () {
                    var tabName = this.getAttribute('data-tab');
                    tabBtns.forEach(function (b) { b.classList.remove('active'); });
                    this.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(function (c) { c.classList.remove('active'); });
                    document.getElementById('tab_' + tabName).classList.add('active');
                });
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞
            google.script.run.withSuccessHandler(function (r) {
                console.log('Products loaded:', r ? r.length : 0);
                products = r || [];
                initProductTA();
            }).getProducts();
            google.script.run.withSuccessHandler(function (r) {
                console.log('Clients loaded:', r ? r.length : 0);
                clients = r || [];
                if (clients.length === 0) {
                    showToast('‚ö† –ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–∏—Å—Ç "clients"', true);
                } else {
                    // showToast('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç–æ–≤: ' + clients.length); // Optional: verbose
                }
                initClientTA(); initSchClientTA(); initClSearchTA();
            }).getClients();
            google.script.run.withSuccessHandler(function (r) {
                console.log('Staff loaded:', r ? r.length : 0);
                staff = r || [];
                initTrainerTA(); initSchTrainerTA();
            }).getStaff();

            loadTasks();

            // –î–∞—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            var dt = new Date();
            document.getElementById('sb_date').value = String(dt.getDate()).padStart(2, '0') + '.' + String(dt.getMonth() + 1).padStart(2, '0') + '.' + dt.getFullYear();
            document.getElementById('sch_date').value = dt.toISOString().split('T')[0];

            document.getElementById('sch_date').addEventListener('change', checkConflicts);
            document.getElementById('sch_time').addEventListener('input', checkConflicts);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('sb_discount').addEventListener('input', recalcSBFinal);
            document.getElementById('sb_product').addEventListener('blur', onSBProductBlur);
            document.getElementById('sb_add').addEventListener('click', onSBAdd);
            document.getElementById('sch_add').addEventListener('click', onSchAdd);
            document.getElementById('tasks_refresh').addEventListener('click', function (e) { e.stopPropagation(); loadTasks(); });

            // Dropdowns on focus/click for all search fields
            ['sb_trainer', 'sch_trainer', 'sb_client', 'sch_client', 'sb_product', 'cl_search'].forEach(function (id) {
                var inp = document.getElementById(id);
                if (!inp) return;
                inp.addEventListener('focus', function () {
                    var event = new Event('input');
                    this.dispatchEvent(event);
                });
                inp.addEventListener('click', function () {
                    var event = new Event('input');
                    this.dispatchEvent(event);
                });
            });

            // Switch Logic - Type
            var typeOptions = document.querySelectorAll('#sw_type_container .switch-option');
            typeOptions.forEach(function (opt) {
                opt.addEventListener('click', function () {
                    typeOptions.forEach(function (o) { o.classList.remove('active'); });
                    this.classList.add('active');
                    sch_roomType = this.getAttribute('data-val');
                    var container = document.getElementById('sw_type_container');
                    if (sch_roomType === "–í–∞–Ω–Ω—ã") {
                        container.classList.add('right');
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π
                        sch_category = "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π";
                        document.getElementById('sw_cat_container').classList.add('disabled');
                        var catOpts = document.querySelectorAll('#sw_cat_container .switch-option');
                        catOpts.forEach(function (o) { o.classList.remove('active'); });
                        document.getElementById('sw_cat_ind').classList.add('active');
                        document.getElementById('sw_cat_container').classList.remove('right');
                    } else {
                        container.classList.remove('right');
                        document.getElementById('sw_cat_container').classList.remove('disabled');
                    }
                    checkConflicts();
                });
            });

            // Switch Logic - Category
            var catOptions = document.querySelectorAll('#sw_cat_container .switch-option');
            catOptions.forEach(function (opt) {
                opt.addEventListener('click', function () {
                    if (sch_roomType !== "–ë–∞—Å—Å–µ–π–Ω") return;
                    catOptions.forEach(function (o) { o.classList.remove('active'); });
                    this.classList.add('active');
                    sch_category = this.getAttribute('data-val');
                    var container = document.getElementById('sw_cat_container');
                    if (sch_category === "–ì—Ä—É–ø–ø–æ–≤–æ–π") container.classList.add('right');
                    else container.classList.remove('right');
                    checkConflicts();
                });
            });
        }

        // ===== –ö–õ–ò–ï–ù–¢–°–ö–ê–Ø –ö–ê–†–¢–û–ß–ö–ê =====
        function updateClientCard(prefix, item) {
            var card = document.getElementById(prefix + '_client_card');
            var info = document.getElementById(prefix + '_client_info');

            if (!item) {
                if (card) card.style.display = 'none';
                if (info) info.style.display = 'none';
                return;
            }

            // Info text for Sales/Schedule tabs
            if (info) {
                var infoText = '–ë–∞–ª–∞–Ω—Å: ' + formatNum(item.balance || 0) + ' | –°–ø–∏—Å–∞–Ω–æ: ' + formatNum(item.spent || 0);
                var dVal = parseFloat((item.debt || 0).toString().replace(',', '.'));
                if (!isNaN(dVal)) {
                    if (dVal > 0) {
                        infoText += ' | <span style="color:#d32f2f; font-weight:700;">–ï—Å—Ç—å –¥–æ–ª–≥: ' + formatNum(dVal) + '</span>';
                    } else if (dVal < 0) {
                        infoText += ' | <span style="color:#2e7d32; font-weight:700;">–¶–µ–Ω—Ç—Ä –¥–æ–ª–∂–µ–Ω –∫–ª–∏–µ–Ω—Ç—É ' + formatNum(Math.abs(dVal)) + '</span>';
                    }
                }
                info.innerHTML = infoText;
                info.style.display = 'block';
            }

            if (card) {
                card.style.display = 'block';
                // Note: cl_card_fio was removed, so we don't set it anymore
                if (prefix === 'cl') {
                    setText('cl_card_phone', item.phone);
                    setText('cl_card_balance', formatNum(item.balance));
                    setText('cl_card_spent', formatNum(item.spent));
                    setText('cl_card_debt', formatNum(item.debt));
                    setText('cl_card_child', item.childName || '-'); // Use column C specifically
                    setText('cl_card_dr', item.childDate);
                    setText('cl_card_age', item.age);
                    setText('cl_card_status', item.status);

                    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
                    setHtml('cl_sales_list', '<div class="note">–ó–∞–≥—Ä—É–∑–∫–∞...</div>');
                    setHtml('cl_training_list', '');
                    google.script.run.withSuccessHandler(function (history) {
                        renderClientHistory(history);
                    }).getClientHistory(item.name);
                }
            }
        }

        function renderClientHistory(history) {
            // 1. –ü–æ–∫—É–ø–∫–∏
            var sList = document.getElementById('cl_sales_list');
            if (!history.sales || !history.sales.length) {
                sList.innerHTML = '<div class="note">–ü–æ–∫—É–ø–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            } else {
                var sHtml = '<table class="history-table"><tr><th>–î–∞—Ç–∞</th><th>–ü—Ä–æ–¥—É–∫—Ç</th><th>–¶–µ–Ω–∞</th></tr>';
                history.sales.forEach(function (s) {
                    sHtml += '<tr><td>' + s.date + '</td><td>' + s.product + '</td><td>' + formatNum(s.price) + '</td></tr>';
                });
                sHtml += '</table>';
                sList.innerHTML = sHtml;
            }

            // 2. –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
            var tList = document.getElementById('cl_training_list');
            if (!history.training || !history.training.length) {
                tList.innerHTML = '<div class="note">–ó–∞–ø–∏—Å–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            } else {
                var tHtml = '<table class="history-table"><tr><th>–î–∞—Ç–∞</th><th>–¢—Ä–µ–Ω–µ—Ä</th><th>–¢–∏–ø</th><th>–°—Ç–∞—Ç—É—Å</th></tr>';
                history.training.forEach(function (t) {
                    var rowStyle = (t.status === '–û—Ç–º–µ–Ω–∞' || t.status === '–ü—Ä–æ–ø—É—Å–∫') ? 'style="color:#999; text-decoration:line-through;"' : '';
                    tHtml += '<tr ' + rowStyle + '><td>' + t.date + ' ' + t.time + '</td><td>' + t.trainer + '</td><td>' + t.type + '</td><td>' + t.status + '</td></tr>';
                });
                tHtml += '</table>';
                tList.innerHTML = tHtml;
            }
        }

        // ===== –ü–†–û–í–ï–†–ö–ê –ö–û–ù–§–õ–ò–ö–¢–û–í =====
        function checkConflicts() {
            var date = document.getElementById('sch_date').value;
            var time = document.getElementById('sch_time').value;
            var trainer = sch_selectedTrainer ? sch_selectedTrainer.name : null;
            var client = sch_matchedClient ? sch_matchedClient.name : null;

            // –í—Ä–µ–º—è: –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ 10 –∏ 30 –º–∏–Ω—É—Ç
            var timeNote = document.getElementById('sch_time_note');
            if (time) {
                var mins = parseInt(time.split(':')[1]);
                if (mins % 10 !== 0) {
                    setText('sch_time_err', '–¢–æ–ª—å–∫–æ –∫—Ä–∞—Ç–Ω–æ 10 –º–∏–Ω (–Ω–∞–ø—Ä. 10:10, 10:20)');
                } else {
                    setText('sch_time_err', '');
                    if (mins % 30 !== 0) {
                        timeNote.textContent = '‚ö† –ù–µ—Ç–∏–ø–∏—á–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞. –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—å—Ç–µ.';
                        timeNote.style.display = 'block';
                    } else {
                        timeNote.style.display = 'none';
                    }
                }
            } else {
                timeNote.style.display = 'none';
            }

            if (!date || !time || (!trainer && !client)) return;

            google.script.run.withSuccessHandler(function (res) {
                var errDiv = document.getElementById('sch_trainer_conflict');
                if (res.conflict) {
                    errDiv.textContent = '‚ö† ' + res.message;
                    errDiv.style.display = 'block';
                } else {
                    errDiv.style.display = 'none';
                }
            }).checkAvailabilityRealtime(date, time, trainer, client, sch_roomType);
        }

        // ===== –ó–ê–î–ê–ß–ò =====
        function renderTasks(tasks) {
            var list = document.getElementById('tasks_list');
            list.innerHTML = '';
            if (!tasks || !tasks.length) { document.getElementById('tasks_empty').style.display = 'block'; return; }
            document.getElementById('tasks_empty').style.display = 'none';
            tasks.forEach(function (t) {
                var wrap = el('div', { className: 'task' });
                var txt = el('div', { className: 'txt' });
                txt.style.flex = '1';
                txt.style.marginRight = '8px';

                // Try to find client name in task text to link it
                var taskBody = t.task || '';
                var matched = clients.find(function (c) { return taskBody.indexOf(c.name) !== -1; });
                if (matched) {
                    var parts = taskBody.split(matched.name);
                    txt.appendChild(document.createTextNode(parts[0]));
                    var a = el('a', { href: '#', text: matched.name });
                    a.style.color = '#1976d2';
                    a.style.textDecoration = 'none';
                    a.style.fontWeight = '600';
                    a.addEventListener('click', function (e) { e.preventDefault(); openClient(matched.name); });
                    txt.appendChild(a);
                    txt.appendChild(document.createTextNode(parts[1]));
                } else {
                    txt.textContent = taskBody;
                }

                wrap.appendChild(txt);
                if (t.link) {
                    var linkSpan = el('span', { text: ' (üîó –∫ —è—á–µ–π–∫–µ)' });
                    linkSpan.style.fontSize = '10px';
                    linkSpan.style.color = '#1976d2';
                    linkSpan.style.cursor = 'pointer';
                    linkSpan.style.marginLeft = '4px';
                    linkSpan.style.whiteSpace = 'nowrap';
                    linkSpan.addEventListener('click', function () {
                        google.script.run.withFailureHandler(function (err) {
                            showToast('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞: ' + (err.message || err), true);
                        }).openTaskCell(t.link);
                    });
                    txt.appendChild(linkSpan);
                }
                list.appendChild(wrap);
            });
        }

        function loadTasks() {
            var list = document.getElementById('tasks_list');
            list.style.opacity = '0.5';
            google.script.run.withSuccessHandler(function (tasks) {
                list.style.opacity = '1';
                renderTasks(tasks);
            }).getTasks();
        }

        // ===== TYPEAHEAD –û–ë–©–ò–ô =====
        function attachSearch(inpId, listId, srcArray, options) {
            var inp = document.getElementById(inpId), list = document.getElementById(listId);
            inp.addEventListener('input', function () {
                var q = inp.value.trim().toLowerCase();
                var needType = (options && options.typeProvider) ? options.typeProvider() : null;

                // Allow showing all if q is empty but focus/click triggered search
                if (!q && !needType && !options.showAllIfEmpty) { list.style.display = 'none'; return; }

                var matches = [];
                for (var i = 0; i < srcArray.length; i++) {
                    var it = srcArray[i];
                    if (options && options.filter) { if (!options.filter(it, q, needType)) continue; }
                    else {
                        var hay = ((it.name || '') + ' ' + (it.phone || '') + ' ' + (it.childName || '') + ' ' + (it.category || '') + ' ' + (it.type || '')).toLowerCase();
                        if (q && hay.indexOf(q) === -1) continue;
                    }
                    matches.push(it);
                    if (matches.length >= 15) break;
                }
                if (!matches.length) { list.style.display = 'none'; return; }
                list.innerHTML = '';
                matches.forEach(function (m) {
                    var d = el('div', { className: 'typeahead-item' });
                    var label = m.name || '';
                    if (m.phone) label += ' | ' + m.phone;

                    // If it's a client with metadata, show more
                    if (m.balance !== undefined || m.spent !== undefined) {
                        if (m.childName) label += ' (—Ä–µ–±: ' + m.childName + ')';
                        label += ' | –ë: ' + (m.balance || 0) + ' | –û–ø: ' + (m.spent || 0);
                        if (m.debt && parseFloat(m.debt) > 0) label += ' | –î–û–õ–ì: ' + m.debt;
                    } else if (m.childName) {
                        label += ' (—Ä–µ–±: ' + m.childName + ')';
                    }

                    d.textContent = options.itemLabel ? options.itemLabel(m) : label;
                    d.addEventListener('click', function () { list.style.display = 'none'; options.onSelect(m); });
                    list.appendChild(d);
                });
                list.style.display = 'block';
            });

            // Close on click outside
            document.addEventListener('click', function (e) {
                if (!list.contains(e.target) && e.target !== inp) list.style.display = 'none';
            });
            // Close on window blur (when user clicks on the spreadsheet)
            window.addEventListener('blur', function () {
                list.style.display = 'none';
            });
        }

        // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û–ò–°–ö–ê =====
        function initClSearchTA() {
            attachSearch('cl_search', 'cl_search_list', clients, {
                showAllIfEmpty: true,
                onSelect: function (item) {
                    document.getElementById('cl_search').value = item.name || '';
                    updateClientCard('cl', item);
                }
            });
        }

        function initClientTA() {
            attachSearch('sb_client', 'sb_client_list', clients, {
                showAllIfEmpty: true,
                onSelect: function (item) {
                    document.getElementById('sb_client').value = item.name || '';
                    sb_matchedClient = item;
                    setText('sb_client_err', '');
                    updateClientCard('sb', item);
                }
            });
        }

        function initSchClientTA() {
            attachSearch('sch_client', 'sch_client_list', clients, {
                showAllIfEmpty: true,
                onSelect: function (item) {
                    document.getElementById('sch_client').value = item.name || '';
                    sch_matchedClient = item;
                    setText('sch_client_err', '');
                    updateClientCard('sch', item);
                    checkConflicts();
                }
            });
        }

        function initProductTA() {
            attachSearch('sb_product', 'sb_product_list', products, {
                showAllIfEmpty: true,
                itemLabel: function (it) { return it.name + (it.price ? " (" + formatNum(it.price) + ")" : ""); },
                onSelect: function (item) {
                    sb_selectedProduct = item;
                    document.getElementById('sb_product').value = item.name + (item.price ? " (" + formatNum(item.price) + ")" : "");
                    sb_defaultDiscount = computeDefaultDiscount(item);
                    document.getElementById('sb_discount').value = sb_defaultDiscount;
                    setText('sb_product_note', (item.type || '') + (item.category ? (' / ' + item.category) : ''));
                    setText('sb_product_err', '');
                    recalcSBFinal();
                    if (item.type) setText('sb_trainer_note', '–¢—Ä–µ–Ω–µ—Ä—ã: ' + item.type);
                }
            });
        }

        function initTrainerTA() {
            attachSearch('sb_trainer', 'sb_trainer_list', staff, {
                showAllIfEmpty: true,
                typeProvider: function () { return sb_selectedProduct ? sb_selectedProduct.type : null; },
                filter: function (it, q, type) {
                    if (it.type === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä') return false;
                    if (type && it.type !== type) return false;
                    if (!q) return true; // Show all if empty but focused
                    return it.name.toLowerCase().indexOf(q) !== -1;
                },
                onSelect: function (item) {
                    document.getElementById('sb_trainer').value = item.name || '';
                    setText('sb_trainer_note', (item.name || '') + (item.type ? (' (' + item.type + ')') : ''));
                }
            });
        }

        function initSchTrainerTA() {
            attachSearch('sch_trainer', 'sch_trainer_list', staff, {
                showAllIfEmpty: true,
                typeProvider: function () { return sch_roomType; },
                filter: function (it, q, type) {
                    if (it.type === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä') return false;
                    if (type && it.type !== type) return false;
                    if (!q) return true; // Show all if empty
                    return it.name.toLowerCase().indexOf(q) !== -1;
                },
                onSelect: function (item) {
                    document.getElementById('sch_trainer').value = item.name || '';
                    sch_selectedTrainer = item;
                    setText('sch_trainer_note', (item.name || '') + (item.type ? (' (' + item.type + ')') : ''));
                    setText('sch_trainer_err', '');
                    checkConflicts();
                }
            });
        }

        // ===== –ü–†–û–î–ê–ñ–ò - –õ–û–ì–ò–ö–ê =====
        function computeDefaultDiscount(product) {
            if (!product) return 0;
            var t = product.type || '';
            var nameLc = (product.name || '').toString().toLowerCase();
            if ((t === '–ë–∞—Å—Å–µ–π–Ω' || t === '–í–∞–Ω–Ω—ã') && nameLc.indexOf('–ø—Ä–æ–±–Ω–æ–µ') !== -1) return 50;
            if (t === '–ë–∞—Å—Å–µ–π–Ω' || t === '–í–∞–Ω–Ω—ã') return 15;
            return 0;
        }

        function recalcSBFinal() {
            var summaryBlock = document.getElementById('price_summary_block');
            if (!sb_selectedProduct || typeof sb_selectedProduct.price === 'undefined') {
                summaryBlock.style.display = 'none';
                return;
            }
            summaryBlock.style.display = 'block';
            var base = Number(sb_selectedProduct.price) || 0;
            var discStr = (document.getElementById('sb_discount').value || '0').replace(',', '.');
            var disc = parseFloat(discStr);
            if (isNaN(disc) || disc < 0) disc = 0;
            if (disc > 100) disc = 100;
            var final = Math.round((base * (1 - disc / 100)) * 100) / 100;
            var saved = Math.round((base - final) * 100) / 100;

            var html = '<div style="font-size:11px; font-weight:600; color:#1976d2; margin-top:2px;">' +
                '–°–∫–∏–¥–∫–∞ ' + formatNum(saved) + '. –û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–∞—è —Ü–µ–Ω–∞: ' + formatNum(final) + '.' +
                '</div>';
            setHtml('price_summary_block', html);
        }

        function onSBProductBlur() {
            var v = document.getElementById('sb_product').value.trim().toLowerCase();
            if (!v) return;
            var found = products.find(function (p) {
                var label = (p.name + (p.price ? " (" + formatNum(p.price) + ")" : "")).toLowerCase();
                return p.name.toLowerCase() === v || label === v;
            });
            if (found) {
                sb_selectedProduct = found;
                sb_defaultDiscount = computeDefaultDiscount(found);
                document.getElementById('sb_discount').value = sb_defaultDiscount;
                recalcSBFinal();
            }
        }

        function onSBAdd() {
            ['sb_date_err', 'sb_client_err', 'sb_product_err', 'sb_discount_err', 'sb_payment_err', 'sb_comment_err', 'sb_status'].forEach(function (id) { setText(id, ''); });
            var ok = true;
            var date = document.getElementById('sb_date').value.trim();
            if (!date) { setText('sb_date_err', '–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É'); ok = false; }
            else {
                // Validation +/- 7 days
                try {
                    var dateParts = date.split('.');
                    var selDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                    var now = new Date();
                    now.setHours(0, 0, 0, 0);
                    var diffTime = Math.abs(selDate - now);
                    var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays > 7) {
                        setText('sb_date_err', '–î–∞—Ç–∞ –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ +/- 7 –¥–Ω–µ–π');
                        ok = false;
                    }
                } catch (e) { ok = false; }
            }
            if (!sb_matchedClient) { setText('sb_client_err', '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞'); ok = false; }
            if (!sb_selectedProduct) { setText('sb_product_err', '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç'); ok = false; }

            var discStr = (document.getElementById('sb_discount').value || '0').replace(',', '.');
            var discount = parseFloat(discStr);
            if (isNaN(discount) || discount < 0 || discount > 100) { setText('sb_discount_err', '–ù–µ–≤–µ—Ä–Ω–∞—è —Å–∫–∏–¥–∫–∞'); ok = false; }

            var radios = document.getElementsByName('sb_payment');
            var payment = '';
            for (var r = 0; r < radios.length; r++) if (radios[r].checked) payment = radios[r].value;
            if (!payment) { setText('sb_payment_err', '–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–ª–∞—Ç—É'); ok = false; }

            var comment = document.getElementById('sb_comment').value || '';
            var isPoolBath = (sb_selectedProduct.type === '–ë–∞—Å—Å–µ–π–Ω' || sb_selectedProduct.type === '–í–∞–Ω–Ω—ã');
            if (isPoolBath && discount > sb_defaultDiscount && comment.trim() === '') {
                setText('sb_comment_err', '–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π —Å–∫–∏–¥–∫–∏ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏');
                ok = false;
            }

            if (!ok) return;

            var payload = {
                date: date,
                client: { displayName: sb_matchedClient.name, phone: sb_matchedClient.phone },
                product: { name: sb_selectedProduct.name, type: sb_selectedProduct.type, category: sb_selectedProduct.category, price: sb_selectedProduct.price, quantity: sb_selectedProduct.quantity },
                qty: sb_selectedProduct.quantity || 1,
                discount: discount,
                paymentMethod: payment,
                comment: comment,
                trainer: { name: document.getElementById('sb_trainer').value || '' }
            };

            var btn = document.getElementById('sb_add');
            btn.disabled = true; btn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

            google.script.run.withSuccessHandler(function (res) {
                showToast('–ü—Ä–æ–¥–∞–∂–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                btn.disabled = false; btn.textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É';
                document.getElementById('sb_client').value = ''; setText('sb_client_note', '');
                document.getElementById('sb_product').value = ''; setText('sb_product_note', '');
                document.getElementById('sb_discount').value = 0;
                document.getElementById('sb_comment').value = '';
                document.getElementById('sb_trainer').value = '';
                for (var i = 0; i < radios.length; i++) radios[i].checked = false;
                setHtml('price_summary_block', ''); document.getElementById('price_summary_block').style.display = 'none';
                sb_selectedProduct = null; sb_matchedClient = null;
                document.getElementById('sb_client_card').style.display = 'none';
                loadTasks();
            }).withFailureHandler(function (err) {
                showToast('–û—à–∏–±–∫–∞: ' + (err.message || err), true);
                btn.disabled = false; btn.textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É';
            }).createSale(payload);
        }

        // ===== –†–ê–°–ü–ò–°–ê–ù–ò–ï - –õ–û–ì–ò–ö–ê =====
        function onSchAdd() {
            ['sch_date_err', 'sch_time_err', 'sch_trainer_err', 'sch_client_err', 'sch_status'].forEach(function (id) { setText(id, ''); });
            var ok = true;
            var dateVal = document.getElementById('sch_date').value;
            var timeVal = document.getElementById('sch_time').value;
            if (!dateVal) { setText('sch_date_err', '–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É'); ok = false; }
            if (!timeVal) { setText('sch_time_err', '–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è'); ok = false; }

            if (dateVal && timeVal) {
                var now = new Date();
                var sel = new Date(dateVal + 'T' + timeVal);
                if (sel < now) {
                    setText('sch_time_err', '–ù–µ–ª—å–∑—è –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è');
                    ok = false;
                }
                var mins = parseInt(timeVal.split(':')[1]);
                if (mins % 10 !== 0) {
                    setText('sch_time_err', '–í—Ä–µ–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∫—Ä–∞—Ç–Ω–æ 10 –º–∏–Ω—É—Ç–∞–º');
                    ok = false;
                }
            }
            if (!sch_selectedTrainer) { setText('sch_trainer_err', '–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–Ω–µ—Ä–∞'); ok = false; }
            if (!sch_matchedClient) { setText('sch_client_err', '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞'); ok = false; }

            if (!ok) return;

            var payload = {
                date: dateVal,
                time: timeVal,
                room: sch_roomType,
                category: sch_category,
                trainer: sch_selectedTrainer.name,
                client: sch_matchedClient.name
            };

            var btn = document.getElementById('sch_add');
            btn.disabled = true; btn.textContent = '–ó–∞–ø–∏—Å—å...';

            google.script.run.withSuccessHandler(function (res) {
                showToast('–ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞!');
                btn.disabled = false; btn.textContent = '–ó–∞–ø–∏—Å–∞—Ç—å';
                document.getElementById('sch_client').value = ''; setText('sch_client_note', '');
                document.getElementById('sch_trainer').value = ''; setText('sch_trainer_note', '');
                sch_matchedClient = null; sch_selectedTrainer = null;
                loadTasks();
            }).withFailureHandler(function (err) {
                showToast('–û—à–∏–±–∫–∞: ' + (err.message || err), true);
                btn.disabled = false; btn.textContent = '–ó–∞–ø–∏—Å–∞—Ç—å';
            }).addTraining(payload);
        }

        document.addEventListener('DOMContentLoaded', initSidebar);
    </script>
</body>

</html>